#!/bin/bash
# Mise à jour du système
sudo apt-get update
sudo apt-get upgrade -y

# Installez votre base de données (par exemple, MySQL)
sudo apt-get install -y mysql-server

# Exécutez ifconfig pour obtenir la liste des interfaces réseau et leurs adresses IP
ifconfig_output=$(ifconfig)

# Utilisez awk pour extraire les adresses IP publiques (excluant les adresses privées)
public_ips=$(echo "$ifconfig_output" | awk '/inet / && !/127.0.0.1/ && !/inet 10\./ {gsub(/addr:/, "", $2); print $2}')

echo "$public_ips" > /vagrant/shared/dbIpAddr.txt
sudo su
echo "bind-address = $public_ips" >> /etc/mysql/my.cnf
exit
mysql < /vagrant/shared/data_sql_create.sql

while ! sudo mysqladmin ping -hlocalhost -uroot -p"root" --silent; do
    sleep 1
done
# Ne fonctionnent pas pour le moment
mysql -uroot -p"root" -e "CREATE USER 'server'@'192.168.56.%' IDENTIFIED BY '4#j4TA-qNf5yj5M5^3D+';"
mysql -uroot -p"root" -e "GRANT ALL PRIVILEGES ON MonSite.* TO 'server'@'192.168.56.%';"

echo -e "\e[34mProvisionnement de la BDD terminé\e[O"
