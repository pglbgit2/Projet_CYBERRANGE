#!/bin/bash
# Mise à jour du système
sudo apt-get update
sudo apt-get upgrade -y

# Installez votre base de données (par exemple, MySQL)
sudo apt-get install -y mysql-server

# Exécutez ifconfig pour obtenir la liste des interfaces réseau et leurs adresses IP
ifconfig_output=$(ifconfig)

# Utilisez awk pour extraire les adresses IP publiques (excluant les adresses privées)
public_ips=$(echo "$ifconfig_output" | awk '/inet / && !/127.0.0.1/ && !/inet 10\./ {gsub(/addr:/, "", $2); print $2}' | tr -d '\n')

echo -n "$public_ips" > /vagrant/shared/dbIpAddr.txt

sudo sed -i 's/^bind-address.*/bind-address = 0.0.0.0/g' /etc/mysql/mysql.conf.d/mysqld.cnf
#echo "bind-address = 0.0.0.0" >> /etc/mysql/my.cnf
sudo systemctl restart mysql
sudo mysql < /vagrant/shared/data_sql_create.sql

while ! sudo mysqladmin ping -hlocalhost -uroot -p"root" --silent; do
    sleep 1
done
# Ne fonctionnent pas pour le moment
sudo mysql -u root -e "CREATE USER 'server'@'192.168.56.%' IDENTIFIED BY '4#j4TA-qNf5yj5M5^3D+';"
sudo mysql -u root  -e "GRANT ALL PRIVILEGES ON MonSite.* TO 'server'@'192.168.56.%';"

echo -e "\e[34mProvisionnement de la BDD terminé\e[O"
