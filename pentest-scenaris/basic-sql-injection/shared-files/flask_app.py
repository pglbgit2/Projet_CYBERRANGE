from flask import Flask, render_template, jsonify, request
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

app = Flask(__name__)

# Récupération de l'ip bdd
with open('/vagrant/shared/dbIpAddr.txt', 'r') as f:
    dbAddr = f.readline().strip()
    print("L'adresse de la bdd est :",dbAddr)
    app.config['MYSQL_HOST'] = dbAddr

app.config['MYSQL_USER'] = 'server'
app.config['MYSQL_PASSWORD'] = '4#j4TA-qNf5yj5M5^3D+'
app.config['MYSQL_DB'] = 'MonSite'

# Créez une URL de connexion à la base de données MySQL
db_url = 'mysql://' + app.config['MYSQL_USER'] +':'+ app.config['MYSQL_PASSWORD'] + '@'+ app.config['MYSQL_HOST'] +'/' + app.config['MYSQL_DB']

# Créez une instance de moteur SQLAlchemy
engine = create_engine(db_url)

# Créez une session pour interagir avec la base de données
Session = sessionmaker(bind=engine)
session = Session()

@app.route('/')
def showUsers():
    try :
        result = session.execute("SELECT * FROM Users")
        return jsonify([dict(row) for row in result])
    except Exception as e:
        print("Erreur d'exécution de la requête", e)

@app.route('/form', methods= ['POST', 'GET'])
def frontend():
    if request.method == 'GET':
        return render_template('formulaire-connexion.html', name="Frontend")
    else:
        # return "Yes sir"
        email = request.form['email'] 
        passwd = request.form['password']
        if(email is None or passwd is None):
            return "Paramètres manquants", 400
        try :
            sql = f"SELECT * FROM Users WHERE Email = '{email}' and Pwd = '{passwd}';"
            result = session.execute(sql)
            if(result.rowcount > 0):
                return jsonify({'message': "Connexion réussie", 'details':[dict(row) for row in result]}), 200
            else:
                return "Authentification échouée", 400
        except Exception as e:
            return "Une erreur interne s'est produite" + str(e), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', debug=True)